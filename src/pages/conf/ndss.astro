---
import { loadConference } from "../../lib/fetchData";
import PaperCard from "../../components/PaperCard.astro";

const now = new Date();
const currentYear = now.getFullYear();
const data = await loadConference("ndss", currentYear);
const years = Array.from({length: 5}, (_,i)=> currentYear - i);
const selectedYear = Astro.url.searchParams.get('year') ?? String(data.year ?? currentYear);

let items = data.items ?? [];
if (Number(selectedYear) !== data.year) {
  const other = await loadConference("ndss", Number(selectedYear));
  items = other.items ?? [];
}
const q = Astro.url.searchParams.get('q')?.toLowerCase() ?? '';
const filtered = items.filter(p => {
  const hay = [p.title, ...(p.authors||[]), ...(p.tags||[]), p.llm_summary_zh||''].join(' ').toLowerCase();
  return hay.includes(q);
});
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NDSS — Security Papers</title>
    <style>
      body { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; }
      .row { display:flex; gap: .75rem; align-items:center; flex-wrap: wrap; }
      select, input { padding: .5rem .6rem; border-radius: 8px; border:1px solid color-mix(in oklab, CanvasText 20%, transparent); }
      .grid { display:grid; gap:1rem; margin-top:1rem; }
    </style>
  </head>
  <body>
    <h1>NDSS</h1>
    <div class="row">
      <label>Year:
        <select onchange="location.search='?year=' + this.value + (qEl.value?('&q='+encodeURIComponent(qEl.value)):'')">
          {years.map(y => <option value={y} selected={String(y)===String(selectedYear)}>{y}</option>)}
        </select>
      </label>
      <input id="q" placeholder="Search title/author/tag…" value={q} oninput="location.search='?year='+encodeURIComponent('{selectedYear}')+'&q='+encodeURIComponent(this.value)" />
    </div>
    <p style="opacity:.7;margin:.5rem 0 0">{filtered.length} results</p>
    <section class="grid">
      {filtered.map(p => <PaperCard paper={p} />)}
    </section>
    <script>
      const qEl = document.getElementById('q');
    </script>
  </body>
</html>
